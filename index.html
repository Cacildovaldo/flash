<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pong Betting Game</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #121212; color: #fff; text-align: center; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .lang-toggle { position: absolute; top: 10px; right: 10px; }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; border: none; border-radius: 8px; background: #00bcd4; color: white; cursor: pointer; }
    select, input { padding: 10px; font-size: 16px; }
    #waitingList { margin-top: 20px; }
  </style>
</head>
<body>
<div class="lang-toggle">
  <select id="languageSelect" onchange="switchLanguage()">
    <option value="en">English</option>
    <option value="pt">PortuguÃªs</option>
  </select>
</div>
<div class="container">
  <h1 id="title">Pong Betting Game</h1>
  <canvas id="demoCanvas" width="400" height="200" style="border:1px solid #ccc;"></canvas>
  <button onclick="startPlaySection()" id="playBtn">Play</button>

  <div id="playSection" style="display:none;">
    <button onclick="connectWallet()">Connect Wallet</button>
    <select id="betAmount">
      <option value="10500000">10 USDC</option>
      <option value="52500000">50 USDC</option>
      <option value="105000000">100 USDC</option>
      <option value="1050000000">1000 USDC</option>
      <option value="10500000000">10,000 USDC</option>
      <option value="52500000000">50,000 USDC</option>
      <option value="105000000000">100,000 USDC</option>
    </select>
    <button onclick="depositBet()">Deposit Bet</button>

    <h3>Waiting Players</h3>
    <div id="waitingList"></div>
  </div>
</div>

<script>
let provider, signer, contract;
const CONTRACT_ADDRESS = "0x43BFA7D787C0D8ee8aC4651c423E3d623Ea53864";
const CONTRACT_ABI = [
  {"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
  {"inputs":[],"name":"USDC","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"depositBet","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"opponent","type":"address"}],"name":"challengePlayer","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"address","name":"loser","type":"address"}],"name":"declareWinner","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"withdrawBet","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"getWaitingPlayers","outputs":[{"internalType":"address[]","name":"","type":"address[]"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"player","type":"address"}],"name":"getGame","outputs":[{"components":[{"internalType":"address","name":"player1","type":"address"},{"internalType":"address","name":"player2","type":"address"},{"internalType":"uint256","name":"betAmount","type":"uint256"},{"internalType":"bool","name":"active","type":"bool"}],"internalType":"struct PongBetGame.Game","name":"","type":"tuple"}],"stateMutability":"view","type":"function"}
];

async function connectWallet() {
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
  alert("Wallet connected");
  updateWaitingPlayers();
}

async function depositBet() {
  const amount = document.getElementById("betAmount").value;
  const usdc = new ethers.Contract(await contract.USDC(), CONTRACT_ABI, signer);
  await usdc.approve(CONTRACT_ADDRESS, amount);
  const tx = await contract.depositBet(amount);
  await tx.wait();
  alert("Bet deposited");
  updateWaitingPlayers();
}

async function updateWaitingPlayers() {
  const amount = document.getElementById("betAmount").value;
  const players = await contract.getWaitingPlayers(amount);
  const list = document.getElementById("waitingList");
  list.innerHTML = "";
  players.forEach(addr => {
    const short = addr.slice(-6);
    const btn = document.createElement("button");
    btn.innerText = `Challenge ${short}`;
    btn.onclick = () => challenge(addr);
    list.appendChild(btn);
  });
}

async function challenge(addr) {
  const tx = await contract.challengePlayer(addr);
  await tx.wait();
  alert("Challenged. Start the game!");
}

function startPlaySection() {
  document.getElementById("playSection").style.display = "block";
}

function switchLanguage() {
  const lang = document.getElementById("languageSelect").value;
  document.getElementById("title").innerText = lang === "pt" ? "Jogo de Apostas Pong" : "Pong Betting Game";
  document.getElementById("playBtn").innerText = lang === "pt" ? "Jogar" : "Play";
  document.querySelector("button[onclick='connectWallet()']").innerText = lang === "pt" ? "Conectar Carteira" : "Connect Wallet";
  document.querySelector("button[onclick='depositBet()']").innerText = lang === "pt" ? "Depositar Aposta" : "Deposit Bet";
  document.querySelector("h3").innerText = lang === "pt" ? "Jogadores Aguardando" : "Waiting Players";
}

// Simple demo Pong game
const canvas = document.getElementById("demoCanvas");
const ctx = canvas.getContext("2d");
let ball = { x: 200, y: 100, vx: 2, vy: 2, r: 8 };
function demoGame() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.beginPath();
  ctx.arc(ball.x, ball.y, ball.r, 0, 2 * Math.PI);
  ctx.fillStyle = "#00bcd4";
  ctx.fill();
  ball.x += ball.vx; ball.y += ball.vy;
  if(ball.x < ball.r || ball.x > canvas.width - ball.r) ball.vx *= -1;
  if(ball.y < ball.r || ball.y > canvas.height - ball.r) ball.vy *= -1;
  requestAnimationFrame(demoGame);
}
demoGame();
</script>
</body>
</html>
